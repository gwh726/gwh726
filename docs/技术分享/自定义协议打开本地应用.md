# 自定义协议打开本地应用

最近在弄调用硬件如指纹仪等的相关工作，使用场景上会有两种（浏览器上调用，客户端程序调用），于是打算封装一个服务层，提供websocket接口来供上层服务调用，客户端程序就比较容易，可以通过进程拉起本地应用就可以了。但是浏览器就不太方便了，可以是做成服务开机自启动。本文介绍的是另一种方式，通过js主动触发调用器本地应用，开启本地服务，还可支持传参；不需要时，调用定义好的api发送指令退出应用程序。

以下介绍windows及uos下实现的过程。

## windows


> ```ini
  Windows Registry Editor Version 5.00

  [HKEY_CLASSES_ROOT\protocoldemo]
  @="URL:demo protocol"
  "URL Protocol"=""

  [HKEY_CLASSES_ROOT\protocoldemo\DefaultIcon]
  @="protocolDemo.exe"

  [HKEY_CLASSES_ROOT\protocoldemo\Shell]

  [HKEY_CLASSES_ROOT\protocoldemo\Shell\Open]

  [HKEY_CLASSES_ROOT\protocoldemo\Shell\Open\Command]
  @="\"F:\\protocoldemo\\protocoldemo.exe\" -- \"%1\""
```



1. 编写xxx.reg文件，输入以上内容
2. 其中protocoldemo就是自定义协议，如浏览器中执行`window.open('protocoldemo://port=1000')`，就可以打开本机程序
3. 打开的程序为最后一行中`F:\\protocoldemo\\protocoldemo.exe`指定的可执行文件
4. `%1`为参数，就是步骤2中的`protocoldemo://port=1000`
5. 执行此文件将其写入注册表后，就可以通过protocoldemo://协议来打开本地应用了

## UOS


> ```ini
[Desktop Entry]
Encoding=UTF-8
Version=1.0
Type=Application
Terminal=false
Exec=/home/administrator/Desktop/protocoldemo -- %u
Name=demo
Comment=demo handler
Icon=
Categories=Appliation;Network
MimeType=x-scheme-handler/protocoldemo
```



1. 
创建xxx.desktop文件，输入以上内容

2. 
其中protocoldemo就是自定义协议，如浏览器中执行`window.open('protocoldemo://port=1000')`，就可以打开本机程序

3. 
Exec中的指向的路径`/home/administrator/Desktop/protocoldemo`为协议打开的可执行文件

4. 
`%u`为参数，就是步骤2中的`protocoldemo://port=1000`

5. 
将创建xxx.desktop文件拷贝至`~/.local/share/applications/`路径下，如：
```shell
cp xxx.desktop ~/.local/share/applications/
```


6. 
执行以下命令，将协议与应用程序关联后，就可以通过protocoldemo://协议来打开本地应用了
```shell
cd ~/.local/share/applications/
xdg-mime default xxx.desktop x-scheme-handler/protocoldemo
```



## 应用程序处理

1. 判断启动参数个数

- 默认就是有一个参数的，为应用程序的执行路径。所以参照以上例子，可判断是传了2个参数还是3个参数
- 若为2个参数，则可能是本地应用进程调用器本程序，程序处理第二个参数（第一个参数为默认的执行路径）
- 若为3个参数，则是浏览器调用，由于以上定义浏览器打开本地应用的协议中，指定的是`protocoldemo.exe -- %1`；所以程序接收到的第二个参数为`--`，估程序处理第三个参数（第一个参数为默认的执行路径），接收到的数据为`protocoldemo://port=1000
- 程序根据需要自行处理接收到的参数
